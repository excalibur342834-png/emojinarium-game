<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–º–æ–¥–∂–∏–Ω–∞—Ä–∏—É–º - –°–µ—Ç–µ–≤–∞—è –∏–≥—Ä–∞</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app {
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Modal Styles */
        .modal {
            display: flex;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .mode-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .mode-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: bold;
        }

        .mode-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .mode-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .server-settings {
            display: none;
            text-align: left;
            margin-top: 20px;
        }

        .server-settings.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .start-btn {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }

        .start-btn:hover {
            background: #45a049;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .status-waiting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-connected {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Header Styles */
        .game-header {
            background: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 0;
            display: none;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .game-title {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            text-align: center;
            flex: 1;
        }

        .game-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .new-movie-btn {
            background: #4CAF50;
            color: white;
        }

        .new-movie-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .clear-field-btn {
            background: #ff9800;
            color: white;
        }

        .clear-field-btn:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }

        .disconnect-btn {
            background: #dc3545;
            color: white;
        }

        .disconnect-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        /* Movie Display */
        .movie-display {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .movie-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .movie-year {
            font-size: 16px;
            opacity: 0.9;
        }

        .loading-movie {
            font-size: 16px;
            opacity: 0.8;
        }

        /* Game Area */
        .container {
            display: flex;
            gap: 20px;
            margin-top: 0;
            display: none;
        }

        .menu {
            width: 320px;
            background: white;
            border-radius: 0 0 0 15px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            max-height: 700px;
        }

        .menu.hidden {
            display: none;
        }

        .menu h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .sections-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .section {
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .section.expanded {
            transform: translateY(0);
            order: -1;
        }

        .section-header {
            background: #f8f9fa;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #495057;
            transition: background-color 0.2s;
        }

        .section-header:hover {
            background: #e9ecef;
        }

        .section-header::after {
            content: '‚ñº';
            font-size: 12px;
            transition: transform 0.3s;
        }

        .section-header.collapsed::after {
            transform: rotate(-90deg);
        }

        .section-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 0;
            background: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .section-content.expanded {
            max-height: 600px;
            padding: 15px;
            overflow-y: auto;
        }

        .menu-item {
            width: 100%;
            aspect-ratio: 1;
            border: 2px dashed #ccc;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            transition: all 0.2s;
            background: #f9f9f9;
            font-size: 24px;
        }

        .menu-item:hover {
            border-color: #007bff;
            background: #e7f3ff;
            transform: scale(1.05);
        }

        .menu-item.dragging {
            opacity: 0.5;
        }

        /* Game Field */
        .game-field {
            flex: 1;
            min-height: 600px;
            background: white;
            border-radius: 0 0 15px 0;
            border: 2px solid #ddd;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .game-object {
            position: absolute;
            cursor: move;
            user-select: none;
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 60px;
            min-height: 60px;
            background: transparent !important;
            border: none !important;
        }

        .game-object.dragging {
            opacity: 0.9;
            transform: scale(1.1);
            z-index: 1000;
            background: transparent !important;
            border: none !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        /* Chat Section */
        .chat-section {
            width: 320px;
            background: white;
            border-radius: 0 0 15px 0;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            display: none;
        }

        .chat-section.active {
            display: flex;
        }

        .chat-header {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            font-weight: bold;
            font-size: 18px;
        }

        .players-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            max-height: 150px;
            overflow-y: auto;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .player-name {
            font-weight: bold;
        }

        .player-score {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .correct-answer-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .correct-answer-btn:hover {
            background: #218838;
        }

        .chat-messages {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            overflow-y: auto;
            max-height: 300px;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .message.system {
            border-left-color: #6c757d;
            background: #e9ecef;
            font-style: italic;
        }

        .message.correct {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        .message-text {
            color: #333;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .send-btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .send-btn:hover {
            background: #0056b3;
        }

        /* Controls for game objects */
        .object-controls {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            pointer-events: none;
        }

        .game-object:hover .object-controls {
            display: block;
        }

        .rotate-handle {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: grab;
            transition: all 0.2s;
            pointer-events: all;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            right: 8px;
            bottom: 8px;
            z-index: 10;
        }

        .rotate-handle:hover {
            background: #0056b3;
            transform: scale(1.1);
        }

        .rotate-handle::after {
            content: '‚ü≥';
        }

        .rotate-handle.rotating {
            cursor: grabbing;
            background: #0056b3;
            transform: scale(1.2);
        }

        /* Instructions */
        .instructions {
            margin-top: 20px;
            text-align: center;
            color: white;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        .instructions.active {
            display: block;
        }

        /* Scrollbar Styles */
        .sections-container::-webkit-scrollbar,
        .chat-messages::-webkit-scrollbar,
        .players-list::-webkit-scrollbar {
            width: 6px;
        }

        .sections-container::-webkit-scrollbar-track,
        .chat-messages::-webkit-scrollbar-track,
        .players-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .sections-container::-webkit-scrollbar-thumb,
        .chat-messages::-webkit-scrollbar-thumb,
        .players-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .section-content::-webkit-scrollbar {
            width: 4px;
        }

        .section-content::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 2px;
        }

        .section-content::-webkit-scrollbar-thumb {
            background: #dee2e6;
            border-radius: 2px;
        }

        .size-indicator {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            white-space: nowrap;
        }

        .rotation-indicator {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            white-space: nowrap;
        }

        /* Placeholder for empty field */
        .field-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
            pointer-events: none;
        }

        .field-placeholder .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div class="modal" id="modeModal">
        <div class="modal-content">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∏–≥—Ä—ã</h2>
            <div class="mode-buttons">
                <button class="mode-btn active" data-mode="single">–û–¥–∏–Ω–æ—á–Ω–∞—è –∏–≥—Ä–∞</button>
                <button class="mode-btn" data-mode="network">–°–µ—Ç–µ–≤–∞—è –∏–≥—Ä–∞</button>
            </div>
            
            <div class="server-settings" id="serverSettings">
                <div class="form-group">
                    <label for="playerName">–í–∞—à–µ –∏–º—è:</label>
                    <input type="text" id="playerName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" value="–ò–≥—Ä–æ–∫">
                </div>
                <div class="form-group">
                    <label for="roomId">ID –∫–æ–º–Ω–∞—Ç—ã:</label>
                    <input type="text" id="roomId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã">
                </div>
                <div id="networkStatus" class="status-message status-waiting">
                    –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...
                </div>
            </div>
            
            <button class="start-btn" id="startBtn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        </div>
    </div>

    <!-- Game Interface -->
    <div class="app">
        <!-- Game Header -->
        <div class="game-header" id="gameHeader">
            <div class="header-top">
                <div class="game-title">üé≠ –≠–º–æ–¥–∂–∏–Ω–∞—Ä–∏—É–º</div>
                <div class="game-controls">
                    <button class="control-btn clear-field-btn" id="clearFieldBtn">–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ</button>
                    <button class="control-btn new-movie-btn" id="newMovieBtn">–ù–æ–≤—ã–π —Ñ–∏–ª—å–º</button>
                    <button class="control-btn disconnect-btn" id="disconnectBtn">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
                </div>
            </div>
            
            <div class="movie-display" id="movieDisplay">
                <div class="movie-title" id="movieTitle">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª—å–º–∞...</div>
                <div class="movie-year" id="movieYear"></div>
                <div class="loading-movie" id="loadingMovie">–ü–æ–ª—É—á–∞–µ–º —Ñ–∏–ª—å–º –∏–∑ —Ç–æ–ø–æ–≤ –ö–∏–Ω–æ–ø–æ–∏—Å–∫–∞...</div>
            </div>
        </div>

        <!-- Game Area -->
        <div class="container" id="gameContainer">
            <div class="menu" id="emojiMenu">
                <h2>üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —ç–º–æ–¥–∑–∏</h2>
                <div class="sections-container" id="sectionsContainer"></div>
            </div>
            
            <div class="game-field" id="gameField">
                <div class="field-placeholder">
                    <div class="icon">üé¨</div>
                    <div>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —ç–º–æ–¥–∑–∏ —Å—é–¥–∞, —á—Ç–æ–±—ã —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ü–µ–Ω—É –∏–∑ —Ñ–∏–ª—å–º–∞!</div>
                </div>
            </div>

            <!-- Chat Section -->
            <div class="chat-section" id="chatSection">
                <div class="chat-header">üí¨ –ß–∞—Ç –∏–≥—Ä—ã</div>
                <div class="players-list" id="playersList"></div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞...">
                    <button class="send-btn" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div class="instructions" id="instructions">
        <p>üéØ <strong>–°–æ–∑–¥–∞–π—Ç–µ —Å—Ü–µ–Ω—É –∏–∑ —Ñ–∏–ª—å–º–∞ –∏—Å–ø–æ–ª—å–∑—É—è —ç–º–æ–¥–∑–∏!</strong></p>
        <p>‚ú® –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —ç–º–æ–¥–∑–∏ ‚Ä¢ üñ±Ô∏è –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —ç–º–æ–¥–∑–∏ –Ω–∞ –ø–æ–ª–µ ‚Ä¢ üîÑ –ü–µ—Ä–µ–º–µ—â–∞–π—Ç–µ —ç–º–æ–¥–∑–∏ –º—ã—à—å—é</p>
        <p>üîç –ö–æ–ª–µ—Å–∏–∫–æ –º—ã—à–∏ –Ω–∞ —ç–º–æ–¥–∑–∏ - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ ‚Ä¢ ‚ü≥ –ó–∞–∂–º–∏—Ç–µ –∏ —Ç—è–Ω–∏—Ç–µ —Ä—É—á–∫—É –≤—Ä–∞—â–µ–Ω–∏—è –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç–∞ ‚Ä¢ ‚ùå –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ —É–¥–∞–ª—è–µ—Ç —ç–º–æ–¥–∑–∏</p>
        <p>üìö –í –∫–∞–∂–¥–æ–π –∏–≥—Ä–µ –¥–æ—Å—Ç—É–ø–Ω—ã 20 —Å–ª—É—á–∞–π–Ω—ã—Ö —ç–º–æ–¥–∑–∏ –∏–∑ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Ä¢ ESC - –∑–∞–∫—Ä—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç—É—é —Å–µ–∫—Ü–∏—é</p>
        <p>üé¨ –§–∏–ª—å–º—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ —Ç–æ–ø–æ–≤ –ö–∏–Ω–æ–ø–æ–∏—Å–∫–∞</p>
    </div>

    <script>
        class NetworkGame {
            constructor() {
                this.socket = null;
                this.roomId = null;
                this.playerId = null;
                this.playerName = '–ò–≥—Ä–æ–∫';
                this.isConnected = false;
                this.isHost = false;
                this.players = new Map();
            }

            connect(roomId, playerName) {
                return new Promise((resolve, reject) => {
                    this.socket = io();
                    this.roomId = roomId;
                    this.playerName = playerName;
                    
                    this.socket.on('connect', () => {
                        this.isConnected = true;
                        this.playerId = this.socket.id;
                        
                        this.socket.emit('join_room', {
                            roomId: roomId,
                            playerName: playerName
                        });
                        
                        resolve({
                            success: true,
                            playerId: this.playerId,
                            isHost: false,
                            roomId: roomId
                        });
                    });
                    
                    this.socket.on('player_joined', (data) => {
                        this.players.clear();
                        data.players.forEach(player => {
                            this.players.set(player.id, player);
                            if (player.id === this.playerId) {
                                this.isHost = player.isHost;
                            }
                        });
                        
                        if (this.onPlayersUpdate) {
                            this.onPlayersUpdate(Array.from(this.players.values()));
                        }
                    });
                    
                    this.socket.on('connect_error', (error) => {
                        reject(error);
                    });
                    
                    setTimeout(() => {
                        if (!this.isConnected) {
                            reject(new Error('Connection timeout'));
                        }
                    }, 5000);
                });
            }

            disconnect() {
                if (this.socket) {
                    this.socket.disconnect();
                }
                this.isConnected = false;
                this.players.clear();
            }

            sendMessage(message) {
                if (!this.isConnected || !this.socket) return;
                
                this.socket.emit('chat_message', {
                    message: message
                });
            }

            startGame() {
                if (!this.isConnected || !this.socket || !this.isHost) return;
                
                this.socket.emit('start_game', {});
            }

            sendCorrectAnswer(playerId) {
                if (!this.isConnected || !this.socket || !this.isHost) return;
                
                this.socket.emit('correct_answer', {
                    playerId: playerId
                });
            }

            onMessage(callback) {
                if (this.socket) {
                    this.socket.on('chat_message', (data) => {
                        callback(data);
                    });
                }
            }

            onPlayersUpdate(callback) {
                this.onPlayersUpdate = callback;
            }

            onGameStart(callback) {
                if (this.socket) {
                    this.socket.on('game_started', (data) => {
                        callback(data);
                    });
                }
            }

            onMovieReveal(callback) {
                if (this.socket) {
                    this.socket.on('movie_reveal', (data) => {
                        callback(data);
                    });
                }
            }

            updatePlayerScore(playerId, points) {
                const player = this.players.get(playerId);
                if (player) {
                    player.score += points;
                }
            }

            getPlayers() {
                return Array.from(this.players.values());
            }
        }

        class EmojinariumGame {
            constructor() {
                this.network = new NetworkGame();
                this.gameMode = 'single';
                this.isHost = false;
                
                this.gameField = document.getElementById('gameField');
                this.sectionsContainer = document.getElementById('sectionsContainer');
                this.movieTitle = document.getElementById('movieTitle');
                this.movieYear = document.getElementById('movieYear');
                this.loadingMovie = document.getElementById('loadingMovie');
                this.movieDisplay = document.getElementById('movieDisplay');
                this.emojiMenu = document.getElementById('emojiMenu');
                this.chatSection = document.getElementById('chatSection');
                this.chatMessages = document.getElementById('chatMessages');
                this.chatInput = document.getElementById('chatInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.playersList = document.getElementById('playersList');
                
                this.objectCounter = 0;
                this.currentMovie = null;
                this.currentExpandedSection = null;
                this.sectionOrder = [];
                this.isRotating = false;
                this.rotationStartAngle = 0;
                this.rotationCurrentAngle = 0;
                
                this.emojiCategories = [
                    {
                        title: 'üòä –≠–º–æ—Ü–∏–∏ –∏ –ª–∏—Ü–∞',
                        emojis: ['üòÉ','üòÑ','üòÜ','üòÇ','üòä','üòá','üôÇ','üíÄ','üòâ','üòå','üòç','ü•∞','üòò','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üò£','üòñ','üò´','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§ï','ü§¢','ü•∂','üòà']
                    },
                    {
                        title: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –õ—é–¥–∏ –∏ –∂–µ—Å—Ç—ã',
                        emojis: ['üëã','ü§ö','üñêÔ∏è','‚úã','üññ','üëå','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üñï','‚òùÔ∏è','üëç','üëé','üëä','‚úä','ü§õ','ü§ù','üôè','‚úçÔ∏è','üí™']
                    },
                    {
                        title: 'üê∂ –ñ–∏–≤–æ—Ç–Ω—ã–µ –∏ –ø—Ä–∏—Ä–æ–¥–∞',
                        emojis: ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêí','üêî','üê§','üê£','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','üê¥','ü¶Ñ','üêù','üêõ','ü¶ã','üêå','üêû','üêú','üê¢','üêç','ü¶é','ü¶ñ','üêô','ü¶ë']
                    },
                    {
                        title: 'üçï –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏',
                        emojis: ['üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','üçÜ','ü•ë','ü•¶','ü•¨','ü•í','üå∂Ô∏è','üåΩ','ü•ï','ü•î','üç†','ü•ê','ü•Ø','üçû','ü•ñ','ü•®','üßÄ','ü•ö','üç≥','üßà','ü•û','üßá','ü•ì','ü•©','üçó','üçñ','ü¶¥','üå≠','üçî','üçü']
                    },
                    {
                        title: 'üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –º–µ—Å—Ç–∞',
                        emojis: ['üöó','üöï','üöô','üöå','üöé','üèéÔ∏è','üöì','üöë','üöí','üöê','üöö','üöõ','üöú','üèçÔ∏è','üõµ','üö≤','üõ¥','üõπ','üõ∂','‚õµ','üö§','üõ•Ô∏è','‚õ¥Ô∏è','‚úàÔ∏è','üõ©Ô∏è','üöÅ','üöü','üö†','üö°','üõ∞Ô∏è','üöÄ','üõ∏']
                    },
                    {
                        title: '‚öΩ –°–ø–æ—Ä—Ç –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                        emojis: ['‚öΩ','üèÄ','ü•é','üèê','üèâ','ü•è','üéø','üèÜ','üèÖ','üè∏','üéØ','üé≥','ü•ä','ü•ã']
                    },
                    {
                        title: 'üî¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏ —Å–∏–º–≤–æ–ª—ã',
                        emojis: ['‚ûï','‚ûñ','‚úñÔ∏è','‚ûó','‚ôæÔ∏è']
                    },
                    {
                        title: 'üî∑ –ì–µ–æ–º–µ—Ç—Ä–∏—è –∏ —Ñ–∏–≥—É—Ä—ã',
                        emojis: ['üü†','üü£','üü§','üüß','üü®','üü©','üî∂','üî∫']
                    },
                    {
                        title: 'üéµ –ú—É–∑—ã–∫–∞ –∏ –∏—Å–∫—É—Å—Å—Ç–≤–æ',
                        emojis: ['üéµ','üé§','üéß','üé∑','üé∏','üéπ','üé∫','üéª','ü•Å','üé≠','üé®','üé¨','üéÆ','üéØ','üé≤','‚ô†Ô∏è','‚ô•Ô∏è','‚ô¶Ô∏è','‚ô£Ô∏è','üÉè','üÄÑ','üé≠','üñºÔ∏è','üé®','üßµ','üß∂','üëì','üï∂Ô∏è']
                    },
                    {
                        title: 'üåç –ü—Ä–∏—Ä–æ–¥–∞ –∏ –∫–æ—Å–º–æ—Å',
                        emojis: ['üå≤','üå≥','üå¥','üå±','üåø','üçÄ','üéã','üçÉ','üçÇ','üçÅ','üíê','üå∑','üåπ','ü•Ä','üå∫','üåº','üåª','üåú','üåí','üåô','üåé','ü™ê','üí´','‚≠ê','‚ú®','‚ö°','üí•','üî•','‚òÅ','üå™','‚ö°','‚ùÑ','üåà','‚òÄ']
                    },
                    {
                        title: 'üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ –æ—Ñ–∏—Å',
                        emojis: ['üìö','üìñ','üìï','üìí','üìú','üìÑ','üìë','üîñ','üè∑Ô∏è','üí∞','üíµ','üí≥','üíé','‚öñÔ∏è','üö™','üìÅ','üóÇÔ∏è','üìÖ','üóìÔ∏è','üìá','üìà','üìâ','üìä','üìã','üìå','üìé']
                    },
                    {
                        title: '‚ö° –¢–µ—Ö–Ω–∏–∫–∞ –∏ –≥–∞–¥–∂–µ—Ç—ã',
                        emojis: ['üì±','‚òéÔ∏è','üìû','üì†','üîã','üîå','üñ•Ô∏è','üñ®Ô∏è','üíæ','üìÄ','üé•','üì∫','üì∏','üìπ','üí°','üî¶','üïØÔ∏è']
                    },
                    {
                        title: 'üéâ –ü—Ä–∞–∑–¥–Ω–∏–∫–∏ –∏ —Å–æ–±—ã—Ç–∏—è',
                        emojis: ['üéâ','üéä','üéÇ','üç∞','üßÅ','ü•ß','üç´','üç¨','üç≠','üç™','üéÄ','üéÅ','üéà','üß®','‚ú®','üéê','üéé','üéë','üßß','ü™î','üéÑ','üéã','üéÉ','üèÜ','üé™','üé¢']
                    }
                ];

                this.initModal();
            }

            initModal() {
                const modal = document.getElementById('modeModal');
                const modeBtns = document.querySelectorAll('.mode-btn');
                const serverSettings = document.getElementById('serverSettings');
                const startBtn = document.getElementById('startBtn');
                const statusElement = document.getElementById('networkStatus');

                modeBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        modeBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.gameMode = btn.dataset.mode;
                        
                        if (this.gameMode === 'network') {
                            serverSettings.classList.add('active');
                        } else {
                            serverSettings.classList.remove('active');
                        }
                    });
                });

                startBtn.addEventListener('click', async () => {
                    if (this.gameMode === 'network') {
                        const roomId = document.getElementById('roomId').value;
                        const playerName = document.getElementById('playerName').value;

                        if (!roomId) {
                            statusElement.textContent = '–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã!';
                            statusElement.className = 'status-message status-waiting';
                            return;
                        }

                        statusElement.textContent = '–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...';
                        statusElement.className = 'status-message status-waiting';

                        try {
                            const result = await this.network.connect(roomId, playerName);
                            
                            if (result.success) {
                                this.isHost = result.isHost;
                                statusElement.textContent = '–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ!';
                                statusElement.className = 'status-message status-connected';
                                this.startNetworkGame();
                            }
                        } catch (error) {
                            statusElement.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è!';
                            statusElement.className = 'status-message status-waiting';
                        }
                    } else {
                        this.startSingleGame();
                    }
                });
            }

            async startSingleGame() {
                document.getElementById('modeModal').style.display = 'none';
                document.getElementById('gameHeader').style.display = 'block';
                document.getElementById('gameContainer').style.display = 'flex';
                document.getElementById('instructions').classList.add('active');
                
                await this.generateNewMovie();
                this.initSections();
                this.initEventListeners();
            }

            async startNetworkGame() {
                document.getElementById('modeModal').style.display = 'none';
                document.getElementById('gameHeader').style.display = 'block';
                document.getElementById('gameContainer').style.display = 'flex';
                document.getElementById('instructions').classList.add('active');
                
                if (this.isHost) {
                    this.emojiMenu.classList.remove('hidden');
                    this.chatSection.classList.add('active');
                    await this.generateNewMovie();
                    this.initSections();
                } else {
                    this.emojiMenu.classList.add('hidden');
                    this.chatSection.classList.add('active');
                    this.movieDisplay.style.display = 'none';
                    this.createPlayerPlaceholder();
                }
                
                this.initEventListeners();
                this.initNetworkListeners();
                this.updatePlayersList();
            }

            createPlayerPlaceholder() {
                const placeholder = this.gameField.querySelector('.field-placeholder');
                if (placeholder) {
                    placeholder.innerHTML = `
                        <div class="icon">üé≠</div>
                        <div>–°–æ–∑–¥–∞—Ç–µ–ª—å –∏–≥—Ä—ã —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ü–µ–Ω—É –∏–∑ —Ñ–∏–ª—å–º–∞...</div>
                        <div style="margin-top: 10px; font-size: 14px;">–£–≥–∞–¥–∞–π—Ç–µ —Ñ–∏–ª—å–º –∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤ —á–∞—Ç!</div>
                    `;
                }
            }

            initNetworkListeners() {
                this.network.onMessage((data) => {
                    if (data.type === 'chat_message') {
                        this.addChatMessage(data.playerName, data.message, data.isCorrect);
                    }
                });

                this.network.onPlayersUpdate((players) => {
                    this.updatePlayersList();
                });

                this.network.onGameStart((data) => {
                    this.addChatMessage('–°–∏—Å—Ç–µ–º–∞', data.message, true);
                    this.createPlayerPlaceholder();
                });

                this.network.onMovieReveal((movie) => {
                    this.currentMovie = movie;
                    this.movieTitle.textContent = movie.title;
                    this.movieYear.textContent = `–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: ${movie.year}`;
                    this.showLoading(false);
                });
            }

            addChatMessage(sender, message, isSystem = false) {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isSystem ? 'system' : ''} ${message.includes('—É–≥–∞–¥–∞–ª') ? 'correct' : ''}`;
                
                const messageHeader = document.createElement('div');
                messageHeader.className = 'message-header';
                messageHeader.textContent = sender;
                
                const messageText = document.createElement('div');
                messageText.className = 'message-text';
                messageText.textContent = message;
                
                messageElement.appendChild(messageHeader);
                messageElement.appendChild(messageText);
                this.chatMessages.appendChild(messageElement);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            updatePlayersList() {
                this.playersList.innerHTML = '';
                const players = this.network.getPlayers();
                
                players.forEach(player => {
                    const playerElement = document.createElement('div');
                    playerElement.className = 'player-item';
                    
                    const playerName = document.createElement('span');
                    playerName.className = 'player-name';
                    playerName.textContent = player.name + (player.isHost ? ' üëë' : '');
                    
                    const playerScore = document.createElement('span');
                    playerScore.className = 'player-score';
                    playerScore.textContent = player.score;
                    
                    playerElement.appendChild(playerName);
                    playerElement.appendChild(playerScore);
                    
                    if (this.isHost && !player.isHost) {
                        const correctBtn = document.createElement('button');
                        correctBtn.className = 'correct-answer-btn';
                        correctBtn.textContent = '‚úì';
                        correctBtn.title = '–û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç';
                        correctBtn.addEventListener('click', () => {
                            this.network.sendCorrectAnswer(player.id);
                            this.addChatMessage('–°–∏—Å—Ç–µ–º–∞', `‚úÖ ${player.name} –ø–æ–ª—É—á–∞–µ—Ç –±–∞–ª–ª –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç!`, true);
                        });
                        playerElement.appendChild(correctBtn);
                    }
                    
                    this.playersList.appendChild(playerElement);
                });
            }

            async generateNewMovie() {
                this.showLoading(true);
                try {
                    const movie = await this.getRandomMovieFromKinopoisk();
                    this.currentMovie = movie;
                    
                    this.movieTitle.textContent = movie.title;
                    this.movieYear.textContent = `–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: ${movie.year}`;
                    
                    this.clearGameField();
                    this.updateSectionsWithRandomEmojis();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å–º–∞:', error);
                    this.useFallbackMovies();
                } finally {
                    this.showLoading(false);
                }
            }

            async getRandomMovieFromKinopoisk() {
                const topMovies = [
                    { title: "–ü–æ–±–µ–≥ –∏–∑ –®–æ—É—à–µ–Ω–∫–∞", year: "1994" },
                    { title: "–ö—Ä—ë—Å—Ç–Ω—ã–π –æ—Ç–µ—Ü", year: "1972" },
                    { title: "–¢—ë–º–Ω—ã–π —Ä—ã—Ü–∞—Ä—å", year: "2008" },
                    { title: "–ö—Ä—ë—Å—Ç–Ω—ã–π –æ—Ç–µ—Ü 2", year: "1974" },
                    { title: "12 —Ä–∞–∑–≥–Ω–µ–≤–∞–Ω–Ω—ã—Ö –º—É–∂—á–∏–Ω", year: "1957" },
                    { title: "–°–ø–∏—Å–æ–∫ –®–∏–Ω–¥–ª–µ—Ä–∞", year: "1993" },
                    { title: "–í–ª–∞—Å—Ç–µ–ª–∏–Ω –∫–æ–ª–µ—Ü: –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∫–æ—Ä–æ–ª—è", year: "2003" },
                    { title: "–ö—Ä–∏–º–∏–Ω–∞–ª—å–Ω–æ–µ —á—Ç–∏–≤–æ", year: "1994" },
                    { title: "–í–ª–∞—Å—Ç–µ–ª–∏–Ω –∫–æ–ª–µ—Ü: –ë—Ä–∞—Ç—Å—Ç–≤–æ –ö–æ–ª—å—Ü–∞", year: "2001" },
                    { title: "–•–æ—Ä–æ—à–∏–π, –ø–ª–æ—Ö–æ–π, –∑–ª–æ–π", year: "1966" },
                    { title: "–§–æ—Ä—Ä–µ—Å—Ç –ì–∞–º–ø", year: "1994" },
                    { title: "–ë–æ–π—Ü–æ–≤—Å–∫–∏–π –∫–ª—É–±", year: "1999" },
                    { title: "–í–ª–∞—Å—Ç–µ–ª–∏–Ω –∫–æ–ª–µ—Ü: –î–≤–µ –∫—Ä–µ–ø–æ—Å—Ç–∏", year: "2002" },
                    { title: "–ù–∞—á–∞–ª–æ", year: "2010" },
                    { title: "–ó–≤—ë–∑–¥–Ω—ã–µ –≤–æ–π–Ω—ã: –≠–ø–∏–∑–æ–¥ 5 - –ò–º–ø–µ—Ä–∏—è –Ω–∞–Ω–æ—Å–∏—Ç –æ—Ç–≤–µ—Ç–Ω—ã–π —É–¥–∞—Ä", year: "1980" },
                    { title: "–ú–∞—Ç—Ä–∏—Ü–∞", year: "1999" },
                    { title: "–°–ª–∞–≤–Ω—ã–µ –ø–∞—Ä–Ω–∏", year: "1990" },
                    { title: "–ü—Ä–æ–ª–µ—Ç–∞—è –Ω–∞–¥ –≥–Ω–µ–∑–¥–æ–º –∫—É–∫—É—à–∫–∏", year: "1975" },
                    { title: "–°–µ–º—å", year: "1995" },
                    { title: "–ú–æ–ª—á–∞–Ω–∏–µ —è–≥–Ω—è—Ç", year: "1991" }
                ];

                const randomIndex = Math.floor(Math.random() * topMovies.length);
                return topMovies[randomIndex];
            }

            useFallbackMovies() {
                const fallbackMovies = [
                    { title: "–¢–∏—Ç–∞–Ω–∏–∫", year: "1997" },
                    { title: "–ö–æ—Ä–æ–ª—å –õ–µ–≤", year: "1994" },
                    { title: "–ú–∞—Ç—Ä–∏—Ü–∞", year: "1999" },
                    { title: "–ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä –∏ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π –∫–∞–º–µ–Ω—å", year: "2001" },
                    { title: "–ü–∏—Ä–∞—Ç—ã –ö–∞—Ä–∏–±—Å–∫–æ–≥–æ –º–æ—Ä—è", year: "2003" },
                    { title: "–í–ª–∞—Å—Ç–µ–ª–∏–Ω –ö–æ–ª–µ—Ü", year: "2001" },
                    { title: "–ó–≤–µ–∑–¥–Ω—ã–µ –í–æ–π–Ω—ã", year: "1977" },
                    { title: "–•–æ–ª–æ–¥–Ω–æ–µ –°–µ—Ä–¥—Ü–µ", year: "2013" },
                    { title: "–ß–µ–ª–æ–≤–µ–∫-–ø–∞—É–∫", year: "2002" },
                    { title: "–ê–≤–∞—Ç–∞—Ä", year: "2009" }
                ];
                
                const randomIndex = Math.floor(Math.random() * fallbackMovies.length);
                this.currentMovie = fallbackMovies[randomIndex];
                
                this.movieTitle.textContent = this.currentMovie.title;
                this.movieYear.textContent = `–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: ${this.currentMovie.year}`;
            }

            showLoading(show) {
                this.loadingMovie.style.display = show ? 'block' : 'none';
                this.movieYear.style.display = show ? 'none' : 'block';
            }

            getRandomEmojis(emojis, count) {
                const shuffled = [...emojis].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, count);
            }

            updateSectionsWithRandomEmojis() {
                const sections = this.sectionsContainer.querySelectorAll('.section');
                sections.forEach((section, index) => {
                    const content = section.querySelector('.section-content');
                    const menuItems = content.querySelectorAll('.menu-item');
                    
                    const randomEmojis = this.getRandomEmojis(this.emojiCategories[index].emojis, 20);
                    
                    menuItems.forEach((item, itemIndex) => {
                        if (itemIndex < randomEmojis.length) {
                            item.textContent = randomEmojis[itemIndex];
                        }
                    });
                });
            }

            initSections() {
                this.sectionsContainer.innerHTML = '';
                this.sectionOrder = [];
                
                this.emojiCategories.forEach((category, index) => {
                    const section = document.createElement('div');
                    section.className = 'section';
                    section.setAttribute('data-original-index', index);
                    
                    this.sectionOrder.push(index);
                    
                    const sectionHeader = document.createElement('div');
                    sectionHeader.className = 'section-header collapsed';
                    sectionHeader.textContent = category.title;
                    sectionHeader.setAttribute('data-section', index);
                    
                    const sectionContent = document.createElement('div');
                    sectionContent.className = 'section-content';
                    
                    for (let i = 0; i < 20; i++) {
                        const menuItem = document.createElement('div');
                        menuItem.className = 'menu-item';
                        menuItem.setAttribute('data-type', `emoji-${index}-${i}`);
                        menuItem.setAttribute('draggable', 'true');
                        menuItem.textContent = '‚¨ú';
                        sectionContent.appendChild(menuItem);
                    }
                    
                    section.appendChild(sectionHeader);
                    section.appendChild(sectionContent);
                    this.sectionsContainer.appendChild(section);
                });

                this.updateSectionsWithRandomEmojis();
            }

            initEventListeners() {
                document.getElementById('newMovieBtn').addEventListener('click', () => {
                    this.generateNewMovie();
                });

                document.getElementById('clearFieldBtn').addEventListener('click', () => {
                    this.clearGameField();
                });

                document.getElementById('disconnectBtn').addEventListener('click', () => {
                    this.disconnectGame();
                });

                this.sendBtn.addEventListener('click', () => {
                    this.sendChatMessage();
                });

                this.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendChatMessage();
                    }
                });

                this.sectionsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('section-header')) {
                        this.toggleSection(e.target);
                    }
                });

                this.sectionsContainer.addEventListener('dragstart', this.handleDragStart.bind(this));
                this.sectionsContainer.addEventListener('dragend', this.handleDragEnd.bind(this));

                this.gameField.addEventListener('dragover', this.handleDragOver.bind(this));
                this.gameField.addEventListener('drop', this.handleDrop.bind(this));
                this.gameField.addEventListener('click', this.handleDoubleClick.bind(this));
                this.gameField.addEventListener('wheel', this.handleWheel.bind(this), { passive: false });

                this.initKeyboardListeners();
            }

            sendChatMessage() {
                const message = this.chatInput.value.trim();
                if (message) {
                    if (this.gameMode === 'network') {
                        this.network.sendMessage(message);
                    }
                    this.addChatMessage('–í—ã', message);
                    this.chatInput.value = '';
                }
            }

            disconnectGame() {
                if (this.gameMode === 'network') {
                    this.network.disconnect();
                }
                document.getElementById('gameHeader').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'none';
                document.getElementById('instructions').classList.remove('active');
                document.getElementById('modeModal').style.display = 'flex';
            }

            createGameObject(emoji, x, y) {
                const placeholder = this.gameField.querySelector('.field-placeholder');
                if (placeholder) {
                    placeholder.remove();
                }

                const object = document.createElement('div');
                object.className = 'game-object';
                object.setAttribute('data-id', ++this.objectCounter);
                object.setAttribute('data-rotation', '0');
                object.textContent = emoji;
                object.style.fontSize = '50px';
                object.style.width = '90px';
                object.style.height = '90px';

                const rect = this.gameField.getBoundingClientRect();
                const posX = x - rect.left - 45;
                const posY = y - rect.top - 45;

                object.style.left = `${Math.max(20, posX)}px`;
                object.style.top = `${Math.max(20, posY)}px`;

                const controls = document.createElement('div');
                controls.className = 'object-controls';
                
                const rotateHandle = document.createElement('div');
                rotateHandle.className = 'rotate-handle';
                rotateHandle.title = '–ó–∞–∂–º–∏—Ç–µ –∏ —Ç—è–Ω–∏—Ç–µ –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è';
                
                this.addRotationHandler(object, rotateHandle);
                controls.appendChild(rotateHandle);
                object.appendChild(controls);

                this.makeDraggable(object);
                this.addResizeHandler(object);
                this.gameField.appendChild(object);
            }

            addRotationHandler(object, handle) {
                let rotationIndicator = null;

                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    this.isRotating = true;
                    handle.classList.add('rotating');
                    
                    const rect = object.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    
                    this.rotationStartAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * (180 / Math.PI);
                    this.rotationCurrentAngle = parseInt(object.getAttribute('data-rotation')) || 0;
                    
                    rotationIndicator = document.createElement('div');
                    rotationIndicator.className = 'rotation-indicator';
                    rotationIndicator.textContent = `${this.rotationCurrentAngle}¬∞`;
                    object.appendChild(rotationIndicator);

                    const handleMouseMove = (moveEvent) => {
                        if (!this.isRotating) return;
                        
                        const currentAngle = Math.atan2(moveEvent.clientY - centerY, moveEvent.clientX - centerX) * (180 / Math.PI);
                        const angleDiff = currentAngle - this.rotationStartAngle;
                        const newRotation = (this.rotationCurrentAngle + angleDiff) % 360;
                        
                        object.setAttribute('data-rotation', newRotation.toString());
                        object.style.transform = `rotate(${newRotation}deg)`;
                        
                        if (rotationIndicator) {
                            rotationIndicator.textContent = `${Math.round(newRotation)}¬∞`;
                        }
                    };

                    const handleMouseUp = () => {
                        this.isRotating = false;
                        handle.classList.remove('rotating');
                        
                        if (rotationIndicator && rotationIndicator.parentElement) {
                            rotationIndicator.remove();
                        }
                        
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                    };

                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                });
            }

            makeDraggable(element) {
                let isDragging = false;
                let offsetX, offsetY;

                element.addEventListener('mousedown', (e) => {
                    if (e.button !== 0 || e.target.classList.contains('rotate-handle')) return;

                    isDragging = true;
                    element.classList.add('dragging');

                    const rect = element.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;

                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const rect = this.gameField.getBoundingClientRect();
                    let x = e.clientX - rect.left - offsetX;
                    let y = e.clientY - rect.top - offsetY;

                    x = Math.max(0, Math.min(x, rect.width - element.offsetWidth));
                    y = Math.max(0, Math.min(y, rect.height - element.offsetHeight));

                    element.style.left = `${x}px`;
                    element.style.top = `${y}px`;
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        element.classList.remove('dragging');
                    }
                });
            }

            addResizeHandler(element) {
                let resizeIndicator = null;

                element.addEventListener('mouseenter', () => {
                    resizeIndicator = document.createElement('div');
                    resizeIndicator.className = 'size-indicator';
                    resizeIndicator.textContent = `${parseInt(element.style.width)}px`;
                    element.appendChild(resizeIndicator);
                });

                element.addEventListener('mouseleave', () => {
                    if (resizeIndicator && resizeIndicator.parentElement) {
                        resizeIndicator.remove();
                    }
                });

                element.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    const currentWidth = parseInt(element.style.width) || 90;
                    const currentHeight = parseInt(element.style.height) || 90;
                    const currentFontSize = parseInt(element.style.fontSize) || 50;

                    const delta = e.deltaY > 0 ? -10 : 10;
                    const newWidth = Math.max(40, Math.min(300, currentWidth + delta));
                    const newHeight = Math.max(40, Math.min(300, currentHeight + delta));
                    const newFontSize = Math.max(20, Math.min(120, currentFontSize + delta * 0.5));

                    element.style.width = `${newWidth}px`;
                    element.style.height = `${newHeight}px`;
                    element.style.fontSize = `${newFontSize}px`;

                    if (resizeIndicator) {
                        resizeIndicator.textContent = `${newWidth}px`;
                    }
                });
            }

            handleDragStart(e) {
                if (e.target.classList.contains('menu-item')) {
                    const item = e.target;
                    
                    const dragImage = document.createElement('div');
                    dragImage.textContent = item.textContent;
                    dragImage.style.fontSize = '40px';
                    dragImage.style.opacity = '0.8';
                    dragImage.style.position = 'fixed';
                    dragImage.style.left = '-100px';
                    dragImage.style.top = '-100px';
                    document.body.appendChild(dragImage);
                    
                    e.dataTransfer.setData('text/plain', item.textContent);
                    e.dataTransfer.setDragImage(dragImage, 20, 20);
                    
                    setTimeout(() => {
                        document.body.removeChild(dragImage);
                    }, 0);
                    
                    item.classList.add('dragging');
                }
            }

            handleDragEnd(e) {
                if (e.target.classList.contains('menu-item')) {
                    e.target.classList.remove('dragging');
                }
            }

            handleDragOver(e) {
                e.preventDefault();
            }

            handleDrop(e) {
                e.preventDefault();
                const emoji = e.dataTransfer.getData('text/plain');
                this.createGameObject(emoji, e.clientX, e.clientY);
            }

            handleWheel(e) {
                if (e.target.classList.contains('game-object')) {
                    e.preventDefault();
                }
            }

            handleDoubleClick(e) {
                if (e.detail === 2) {
                    const gameObject = e.target.closest('.game-object');
                    if (gameObject) {
                        gameObject.remove();
                        
                        if (this.gameField.querySelectorAll('.game-object').length === 0) {
                            this.showPlaceholder();
                        }
                    }
                }
            }

            initKeyboardListeners() {
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.currentExpandedSection) {
                        this.closeSection(this.currentExpandedSection);
                    }
                });
            }

            toggleSection(header) {
                const section = header.parentElement;
                const content = header.nextElementSibling;
                const isExpanded = content.classList.contains('expanded');
                const originalIndex = parseInt(section.getAttribute('data-original-index'));
                
                if (this.currentExpandedSection && this.currentExpandedSection !== section) {
                    this.closeSection(this.currentExpandedSection);
                }
                
                if (!isExpanded) {
                    this.openSection(section, content, header, originalIndex);
                } else {
                    this.closeSection(section);
                }
            }

            openSection(section, content, header, originalIndex) {
                content.classList.add('expanded');
                header.classList.remove('collapsed');
                section.classList.add('expanded');
                
                this.sectionsContainer.prepend(section);
                this.currentExpandedSection = section;
                
                setTimeout(() => {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                
                const menuItems = content.querySelectorAll('.menu-item');
                menuItems.forEach(item => {
                    item.style.fontSize = '28px';
                });
            }

            closeSection(section) {
                const header = section.querySelector('.section-header');
                const content = section.querySelector('.section-content');
                const originalIndex = parseInt(section.getAttribute('data-original-index'));
                
                content.classList.remove('expanded');
                header.classList.add('collapsed');
                section.classList.remove('expanded');
                this.currentExpandedSection = null;
                
                const allSections = Array.from(this.sectionsContainer.querySelectorAll('.section:not(.expanded)'));
                
                let insertBeforeElement = null;
                for (let i = 0; i < allSections.length; i++) {
                    const currentIndex = parseInt(allSections[i].getAttribute('data-original-index'));
                    if (currentIndex > originalIndex) {
                        insertBeforeElement = allSections[i];
                        break;
                    }
                }
                
                if (insertBeforeElement) {
                    this.sectionsContainer.insertBefore(section, insertBeforeElement);
                } else {
                    this.sectionsContainer.appendChild(section);
                }
            }

            clearGameField() {
                this.gameField.innerHTML = '';
                this.showPlaceholder();
                this.objectCounter = 0;
            }

            showPlaceholder() {
                const placeholder = document.createElement('div');
                placeholder.className = 'field-placeholder';
                
                if (this.isHost || this.gameMode === 'single') {
                    placeholder.innerHTML = `
                        <div class="icon">üé¨</div>
                        <div>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —ç–º–æ–¥–∑–∏ —Å—é–¥–∞, —á—Ç–æ–±—ã —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ü–µ–Ω—É –∏–∑ —Ñ–∏–ª—å–º–∞!</div>
                    `;
                } else {
                    placeholder.innerHTML = `
                        <div class="icon">üé≠</div>
                        <div>–°–æ–∑–¥–∞—Ç–µ–ª—å –∏–≥—Ä—ã —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ü–µ–Ω—É –∏–∑ —Ñ–∏–ª—å–º–∞...</div>
                        <div style="margin-top: 10px; font-size: 14px;">–£–≥–∞–¥–∞–π—Ç–µ —Ñ–∏–ª—å–º –∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤ —á–∞—Ç!</div>
                    `;
                }
                
                this.gameField.appendChild(placeholder);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new EmojinariumGame();
        });
    </script>
</body>
</html>